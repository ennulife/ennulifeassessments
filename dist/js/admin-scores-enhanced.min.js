!function(e){"use strict";window.ENNUAdminEnhanced=window.ENNUAdminEnhanced||{};var t={config:{maxRetries:3,retryDelay:1e3,requestTimeout:3e4,maxRequestsPerMinute:10,debugMode:!1},state:{requestCount:0,lastRequestTime:0,isProcessing:!1,retryAttempts:{}},errors:{log:[],maxLogSize:100},init:function(){try{if(this.log("Initializing ENNU Enhanced Admin System"),!this.checkDependencies())return void this.handleError("Dependencies check failed","DEPENDENCY_ERROR");this.loadConfig(),this.bindEvents(),this.initializeComponents(),this.setupErrorMonitoring(),this.setupPerformanceMonitoring(),this.log("ENNU Enhanced Admin System initialized successfully")}catch(e){this.handleError("Initialization failed: "+e.message,"INIT_ERROR",e)}},checkDependencies:function(){var t=[];return void 0!==e&&void 0!==e.fn.jquery||t.push("jQuery"),"undefined"==typeof ennuAdminEnhanced&&t.push("ennuAdminEnhanced localization object"),!(t.length>0&&(this.log("Missing dependencies: "+t.join(", "),"error"),1))},loadConfig:function(){"undefined"!=typeof ennuAdminEnhanced&&(this.config=e.extend(this.config,ennuAdminEnhanced.security||{}),this.strings=ennuAdminEnhanced.strings||{},this.ajaxUrl=ennuAdminEnhanced.ajaxurl,this.nonce=ennuAdminEnhanced.nonce)},bindEvents:function(){var e=this;try{document.addEventListener("click",function(t){"ennu-recalculate-scores"===t.target.id?e.handleRecalculateScores(t):"ennu-export-data"===t.target.id?e.handleExportData(t):"ennu-sync-hubspot"===t.target.id?e.handleSyncHubSpot(t):"ennu-clear-cache"===t.target.id?e.handleClearCache(t):"ennu-clear-data"===t.target.id&&e.handleClearUserData(t)}),window.addEventListener("unhandledrejection",this.handleUnhandledRejection.bind(this)),window.addEventListener("error",this.handleGlobalError.bind(this)),this.log("Event handlers bound successfully")}catch(e){this.handleError("Failed to bind events: "+e.message,"BIND_ERROR",e)}},initializeComponents:function(){try{e.fn.tooltip&&e(".ennu-enhanced-admin-container [title]").tooltip(),this.animateProgressBars(),this.updateCacheStatus(),this.log("Components initialized successfully")}catch(e){this.handleError("Failed to initialize components: "+e.message,"COMPONENT_ERROR",e)}},setupErrorMonitoring:function(){var t=this;e(document).ajaxError(function(e,n,r,a){r.url&&-1!==r.url.indexOf("ennu_")&&t.handleAjaxError(n,"error",a,r)});var n=console.error;console.error=function(){t.logError("Console Error",Array.prototype.slice.call(arguments).join(" ")),n.apply(console,arguments)}},setupPerformanceMonitoring:function(){window.performance&&window.performance.mark&&window.performance.mark("ennu-admin-init-complete")},handleRecalculateScores:function(t){t.preventDefault();try{var n=e(t.currentTarget),r=this.getUserId();if(!r)return void this.showNotification(this.strings.error||"User ID not found","error");this.performAjaxOperation("recalculate_scores",{user_id:r},n,this.strings.recalculating||"Recalculating scores...")}catch(e){this.handleError("Recalculate scores failed: "+e.message,"RECALCULATE_ERROR",e)}},handleExportData:function(t){t.preventDefault();try{var n=e(t.currentTarget),r=this.getUserId();if(!r)return void this.showNotification(this.strings.error||"User ID not found","error");this.performAjaxOperation("export_user_data",{user_id:r},n,this.strings.exporting||"Exporting data...",this.handleExportSuccess.bind(this))}catch(e){this.handleError("Export data failed: "+e.message,"EXPORT_ERROR",e)}},handleSyncHubSpot:function(t){t.preventDefault();try{var n=e(t.currentTarget),r=this.getUserId();if(!r)return void this.showNotification(this.strings.error||"User ID not found","error");this.performAjaxOperation("sync_hubspot",{user_id:r},n,this.strings.syncing||"Syncing with HubSpot...")}catch(e){this.handleError("HubSpot sync failed: "+e.message,"HUBSPOT_ERROR",e)}},handleClearCache:function(t){t.preventDefault();try{var n=e(t.currentTarget),r=this.getUserId();this.performAjaxOperation("clear_cache",{user_id:r||0},n,this.strings.clearing_cache||"Clearing cache...")}catch(e){this.handleError("Clear cache failed: "+e.message,"CACHE_ERROR",e)}},handleClearUserData:function(t){if(t.preventDefault(),confirm(this.strings.confirm_clear||"Are you sure you want to permanently delete all ENNU assessment data for this user? This cannot be undone."))try{var n=e(t.currentTarget),r=n.data("user-id");if(!r)return void this.showNotification(this.strings.error||"User ID not found","error");this.performAjaxOperation("clear_user_data",{user_id:r},n,"Clearing data...",function(){location.reload()})}catch(e){this.handleError("Clear user data failed: "+e.message,"CLEAR_DATA_ERROR",e)}},performAjaxOperation:function(t,n,r,a,s){var i=this;if(this.state.isProcessing)this.showNotification("Another operation is in progress. Please wait.","warning");else if(this.checkRateLimit()){this.state.isProcessing=!0;var o=e.extend({action:"ennu_"+t,nonce:this.nonce},n);this.setButtonLoading(r,!0,a),this.showNotification(a,"loading"),this.ajaxWithRetry(o,t).done(function(e){i.handleAjaxSuccess(e,r,s)}).fail(function(e,t,n){i.handleAjaxError(e,t,n,{data:o}),i.setButtonLoading(r,!1)}).always(function(){i.state.isProcessing=!1})}else this.showNotification(this.strings.rate_limit||"Too many requests. Please wait a moment.","error")},ajaxWithRetry:function(e,t,n){n=n||1;var r=this;return fetch(this.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(e)}).then(function(e){if(!e.ok)throw new Error("HTTP error! status: ".concat(e.status));return e.json()}).catch(function(a){if(n<r.config.maxRetries&&r.shouldRetry(a)){r.log("Retrying AJAX request for ".concat(t," (attempt ").concat(n+1,"/").concat(r.config.maxRetries,")"));var s=r.config.retryDelay*Math.pow(2,n-1);return new Promise(function(a,i){setTimeout(function(){r.ajaxWithRetry(e,t,n+1).done(a).fail(i)},s)})}return Promise.reject({xhr,status,error:a})})},shouldRetry:function(e,t){return"timeout"===t||"error"===t||0===e.status||e.status>=500&&e.status<600},handleAjaxSuccess:function(e,t,n){try{if(this.setButtonLoading(t,!1),e.success)this.showNotification(e.data.message||this.strings.success||"Operation completed successfully!","success"),n&&"function"==typeof n&&n(e.data),this.refreshPageData();else{var r=e.data&&e.data.message?e.data.message:this.strings.error||"An error occurred. Please try again.";this.showNotification(r,"error")}}catch(e){this.handleError("Success handler failed: "+e.message,"SUCCESS_HANDLER_ERROR",e)}},handleAjaxError:function(e,t,n,r){try{var a=this.strings.error||"An error occurred. Please try again.";0===e.status?a=this.strings.network_error||"Network error. Please check your connection.":403===e.status?a=this.strings.permission_denied||"Permission denied. Please refresh the page and try again.":429===e.status?a=this.strings.rate_limit||"Too many requests. Please wait a moment and try again.":e.status>=500?a="Server error. Please try again later.":"timeout"===t?a="Request timed out. Please try again.":e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message&&(a=e.responseJSON.data.message),this.showNotification(a,"error"),this.logError("AJAX Error",{status:e.status,statusText:t,error:n,url:r?r.url:"unknown",response:e.responseText}),this.sendErrorToServer({type:"ajax_error",status:e.status,statusText:t,error:n,url:r?r.url:"unknown",timestamp:(new Date).toISOString()})}catch(e){this.handleError("Error handler failed: "+e.message,"ERROR_HANDLER_ERROR",e)}},handleExportSuccess:function(e){try{if(e&&e.data){var t=JSON.stringify(e.data,null,2),n=new Blob([t],{type:"application/json"}),r=window.URL.createObjectURL(n),a=document.createElement("a");a.href=r,a.download="ennu-user-data-".concat(e.data._metadata.user_id,"-").concat((new Date).toISOString().split("T")[0],".json"),document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(r)}}catch(e){this.handleError("Export file creation failed: "+e.message,"EXPORT_FILE_ERROR",e)}},checkRateLimit:function(){var e=Date.now();return e-this.state.lastRequestTime>6e4&&(this.state.requestCount=0),!(this.state.requestCount>=this.config.maxRequestsPerMinute||(this.state.requestCount++,this.state.lastRequestTime=e,0))},setButtonLoading:function(e,t,n){t?e.prop("disabled",!0).addClass("ennu-loading").data("original-text",e.text()).html('<span class="dashicons dashicons-update-alt"></span> '+(n||"Loading...")):e.prop("disabled",!1).removeClass("ennu-loading").html(e.data("original-text")||e.text())},showNotification:function(t,n,r){try{var a=e("#ennu-operation-status");if(0===a.length)return;r=r||("error"===n?8e3:4e3),a.removeClass("show loading success error warning").addClass("show "+n).html(this.getNotificationIcon(n)+" "+t),"loading"!==n&&setTimeout(function(){a.removeClass("show")},r)}catch(e){}},getNotificationIcon:function(e){return{loading:'<span class="dashicons dashicons-update-alt"></span>',success:'<span class="dashicons dashicons-yes-alt"></span>',error:'<span class="dashicons dashicons-warning"></span>',warning:'<span class="dashicons dashicons-info"></span>'}[e]||""},animateProgressBars:function(){try{e(".ennu-progress-bar").each(function(){var t=e(this),n=t.css("width");t.css("width","0").animate({width:n},1e3)})}catch(e){this.log("Progress bar animation failed: "+e.message,"warning")}},updateCacheStatus:function(){try{var t=e(".ennu-cache-indicator");t.hasClass("active")&&t.addClass("pulse")}catch(e){this.log("Cache status update failed: "+e.message,"warning")}},refreshPageData:function(){try{this.updateCacheStatus()}catch(e){this.log("Page data refresh failed: "+e.message,"warning")}},getUserId:function(){var t=new URLSearchParams(window.location.search).get("user_id");if(!t){var n=window.location.pathname.match(/user-edit\.php.*user_id=(\d+)/);n&&(t=n[1])}if(!t){var r=e("#user_id");r.length&&(t=r.val())}return t?parseInt(t,10):null},handleError:function(e,t,n){this.logError(t||"GENERAL_ERROR",e,n),this.showNotification("A system error occurred. Please refresh the page and try again.","error")},logError:function(e,t,n){var r={timestamp:(new Date).toISOString(),type:e,message:t,error:n?n.toString():null,stack:n?n.stack:null,userAgent:navigator.userAgent,url:window.location.href};this.errors.log.push(r),this.errors.log.length>this.errors.maxLogSize&&(this.errors.log=this.errors.log.slice(-this.errors.maxLogSize)),this.config.debugMode},sendErrorToServer:function(e){try{if(this.errors.log.length>10)return;fetch(this.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"ennu_log_client_error",nonce:this.nonce,error_data:JSON.stringify(e)})}).catch(function(){})}catch(e){}},handleUnhandledRejection:function(e){this.logError("UNHANDLED_PROMISE_REJECTION",e.reason)},handleGlobalError:function(e){this.logError("GLOBAL_ERROR",e.message,{filename:e.filename,lineno:e.lineno,colno:e.colno})},log:function(e,t){t=t||"info",this.config.debugMode},getErrorLog:function(){return this.errors.log},clearErrorLog:function(){this.errors.log=[]}};e(document).ready(function(){t.init()}),window.ENNUAdminEnhanced=t}(jQuery);
//# sourceMappingURL=admin-scores-enhanced.min.js.map