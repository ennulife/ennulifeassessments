(()=>{document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".ennu-assessment-form").forEach(t=>{new e(t)})});class e{constructor(e){this.form=e,this.currentStep=0,this.isSubmitting=!1,this.questions=this.form.querySelectorAll(".question-slide"),this.totalSteps=this.questions.length;const t=this.form.closest(".ennu-assessment");this.progressBar=t.querySelector(".ennu-progress-fill"),this.progressText=t.querySelector(".progress-text .current-question"),this.totalStepsText=t.querySelector(".progress-text .total-questions"),this.init()}init(){0!==this.totalSteps?(this.totalStepsText&&(this.totalStepsText.textContent=this.totalSteps),this.showQuestion(1),this.calculateAge(),this.bindEvents()):this.form.innerHTML='<p class="ennu-error">No questions found for this assessment.</p>'}bindEvents(){this.form.addEventListener("change",e=>{e.target.matches('input[type="radio"]')&&setTimeout(()=>this.nextQuestion(),300),e.target.matches('select[name^="dob_"]')&&this.calculateAge()}),this.form.addEventListener("click",e=>{e.target.matches(".nav-button.next")&&(e.preventDefault(),this.nextQuestion()),e.target.matches(".nav-button.prev")&&(e.preventDefault(),this.prevQuestion())}),this.form.addEventListener("blur",e=>{e.target.matches('input[name="email"]')&&this.checkEmailExists(e.target)},!0),this.form.addEventListener("submit",e=>{e.preventDefault(),this.submitForm()}),this.form.querySelectorAll('.question-slide[data-question-type="multiselect"] input[type="checkbox"]').forEach(e=>{e.addEventListener("change",e=>{const t=e.target.value,s=e.target.closest(".question-slide").querySelector(".qualifiers-container"),r=s.querySelector(`.qualifier-group[data-qualifier-for="${t}"]`);e.target.checked?(s.style.display="block",r.style.display="block"):(r.style.display="none",0===s.querySelectorAll('.qualifier-group[style*="block"]').length&&(s.style.display="none"))})})}showQuestion(e,t="next"){if(e<1||e>this.totalSteps)return;this.currentStep=e,this.questions.forEach((t,s)=>{t.classList.remove("active"),t.style.display="none",s+1===e&&(t.classList.add("active"),t.style.display="block")}),this.updateProgressBar();const s=this.questions[e-1];if("prev"!==t&&s.dataset.isGlobal){const e=s.querySelectorAll("input[required], select[required]");let t=!0;e.length>0&&(e.forEach(e=>{"radio"===e.type||"checkbox"===e.type?s.querySelector(`input[name="${e.name}"]:checked`)||(t=!1):e.value&&""!==e.value.trim()||(t=!1)}),t&&setTimeout(()=>this.nextQuestion(),500))}}nextQuestion(){this.validateCurrentQuestion()&&(this.currentStep<this.totalSteps?this.showQuestion(this.currentStep+1):this.submitForm())}prevQuestion(){this.currentStep>1&&this.showQuestion(this.currentStep-1,"prev")}updateProgressBar(){if(this.progressBar){const e=this.currentStep/this.totalSteps*100;this.progressBar.style.width=`${e}%`}this.progressText&&(this.progressText.textContent=this.currentStep)}validateCurrentQuestion(){const e=this.questions[this.currentStep-1];e.querySelectorAll(".error-message").forEach(e=>e.remove());let t=!0;const s={};e.querySelectorAll(":scope :is(input, select, textarea)[required]").forEach(e=>{null!==e.offsetParent&&(s[e.name]=e)});for(const r in s){const i=s[r];let n=!0;if("radio"===i.type||"checkbox"===i.type?e.querySelector(`input[name="${r}"]:checked`)||(n=!1):i.value&&""!==i.value.trim()||(n=!1),!n){t=!1;const e=i.closest(".answer-options, .contact-field, .hw-field, .dob-dropdowns");this.showError(e,"Please complete all required fields to continue.")}}return t}showError(e,t){if(e&&!e.nextElementSibling?.classList.contains("error-message")){const s=document.createElement("div");s.className="error-message",s.style.cssText="color: #ef4444; font-size: 0.875rem; text-align: left; margin-top: 0.5rem;",s.textContent=t,e.parentNode.insertBefore(s,e.nextSibling)}}checkEmailExists(e){const t=e.value,s=e.parentElement;if(s.querySelectorAll(".email-check-message").forEach(e=>e.remove()),!t||!this.validateCurrentQuestion())return;const r=new URLSearchParams;r.append("action","ennu_check_email"),r.append("email",t),r.append("nonce",ennu_ajax.nonce),fetch(ennu_ajax.ajax_url,{method:"POST",body:r}).then(e=>e.json()).then(e=>{if(e.success&&e.data.exists){const t=document.createElement("div");t.className="email-check-message notice notice-warning",t.innerHTML=e.data.message,s.appendChild(t)}})}calculateAge(){const e=this.form.querySelector('select[name="dob_month"]'),t=this.form.querySelector('select[name="dob_day"]'),s=this.form.querySelector('select[name="dob_year"]'),r=this.form.querySelector(".calculated-age-display");if(!e||!t||!s)return;const i=parseInt(e.value,10),n=parseInt(t.value,10),o=parseInt(s.value,10);if(i&&n&&o){const e=new Date,t=new Date(o,i-1,n);let s=e.getFullYear()-t.getFullYear();const a=e.getMonth()-t.getMonth();(a<0||0===a&&e.getDate()<t.getDate())&&s--,s>=0&&r?(r.textContent=`Your age is ${s}`,this.combineDOB(),setTimeout(()=>this.nextQuestion(),400)):r&&(r.textContent="")}}combineDOB(){const e=this.form.querySelector('select[name="dob_year"]').value,t=this.form.querySelector('select[name="dob_month"]').value,s=this.form.querySelector('select[name="dob_day"]').value,r=this.form.querySelector('input[name="dob_combined"]');if(t&&s&&e&&r){const i=`${e}-${t.toString().padStart(2,"0")}-${s.toString().padStart(2,"0")}`;r.value=i}}submitForm(){if(this.isSubmitting||!this.validateCurrentQuestion())return;this.isSubmitting=!0,this.form.classList.add("loading");const e=new FormData(this.form),t=this.form.dataset.nonce;if(!t)return alert("Security token missing. Please refresh the page."),this.isSubmitting=!1,void this.form.classList.remove("loading");e.append("nonce",t),fetch(ennu_ajax.ajax_url,{method:"POST",body:e}).then(e=>e.json()).then(e=>{if(e&&!0===e.success)e.data&&e.data.redirect_url?window.location.href=e.data.redirect_url:this.showError(this.form,"Submission successful, but there was an issue redirecting. Please check your dashboard.");else{const t=e.data&&e.data.message?e.data.message:"An unknown error occurred.";this.showError(this.form,t)}}).catch(e=>{console.error("Submission Error:",e),this.showError(this.form,"An unexpected error occurred. Please try again.")}).finally(()=>{this.isSubmitting=!1,this.form.classList.remove("loading")})}}})();